
########################## User's variables #####################
#
# The Caml sources (including camlyacc and camllex source files)

COMMON_DIR = ../common
OUTPUT_DIR = ../../../bin/bin

COMMON_SOURCES = $(COMMON_DIR)/kttools.ml $(COMMON_DIR)/kttypes.ml $(COMMON_DIR)/ktdecl.ml 

XFGEN_SRC = $(COMMON_SOURCES) xftypes.ml xfparser.mly xflexer.mll xflang.ml usercode.ml kttcompare.ml xfgen.ml 
EKTJOIN_SRC = $(COMMON_SOURCES) kttjoin.ml 
EKTCOMPARE_SRC = $(COMMON_SOURCES) xftypes.ml xfparser.mly xflexer.mll xflang.ml usercode.ml kttcompare.ml comparemain.ml

# Generated by ocamllex and ocamlyacc
GENERATED_SRC_FILES = xflexer.ml xfparser.ml xfparser.mli 

# The executable files to generate
XFGEN_EXEC = $(OUTPUT_DIR)/xfgen
EKTJOIN_EXEC = $(OUTPUT_DIR)/kttjoin
EKTCOMPARE_EXEC = $(OUTPUT_DIR)/kttcompare

ALL_EXEC = $(EKTJOIN_EXEC) $(EKTCOMPARE_EXEC) $(XFGEN_EXEC)
ALL_EXEC_OPT = $(addsuffix .opt, $(ALL_EXEC))

CODE_DIRS=-I ../common

########################## Advanced user's variables #####################
#
# The Caml compilers.
# You may fix here the path to access the Caml compiler on your machine
# You may also have to add various -I options.
CAMLC = ocamlc
CAMLOPT = ocamlopt
CAMLDEP = ocamldep
CAMLLEX = ocamllex
CAMLYACC = ocamlyacc

# The list of Caml libraries needed by the program
# For instance:
# LIBS=$(WITHGRAPHICS) $(WITHUNIX) $(WITHSTR) $(WITHNUMS) $(WITHTHREADS)\
# $(WITHDBM)

LIBS=$(WITHSTR)

# Should be set to -custom if you use any of the libraries above
# or if any C code have to be linked with your program
# (irrelevant for ocamlopt)

CUSTOM=-g

# Default setting of the WITH* variables. Should be changed if your
# local libraries are not found by the compiler.
WITHGRAPHICS =graphics.cma -cclib -lgraphics -cclib -L/usr/X11R6/lib -cclib -lX11

WITHUNIX =unix.cma -cclib -lunix

WITHSTR =str.cma -cclib -lstr

WITHNUMS =nums.cma -cclib -lnums

WITHTHREADS =threads.cma -cclib -lthreads

WITHDBM =dbm.cma -cclib -lmldbm -cclib -lndbm

################ End of user's variables #####################


##############################################################
################ This part should be generic
################ Nothing to set up or fix here
##############################################################

all:: .depend.input .depend $(ALL_EXEC)
opt : $(ALL_EXEC_OPT)

#ocamlc -custom other options graphics.cma other files -cclib -lgraphics -cclib -lX11
#ocamlc -thread -custom other options threads.cma other files -cclib -lthreads
#ocamlc -custom other options str.cma other files -cclib -lstr
#ocamlc -custom other options nums.cma other files -cclib -lnums
#ocamlc -custom other options unix.cma other files -cclib -lunix
#ocamlc -custom other options dbm.cma other files -cclib -lmldbm -cclib -lndbm

XFGEN_SMLIY = $(XFGEN_SRC:.mly=.ml)
XFGEN_SMLIYL = $(XFGEN_SMLIY:.mll=.ml)
XFGEN_SMLYL = $(filter %.ml,$(XFGEN_SMLIYL))
XFGEN_OBJS = $(XFGEN_SMLYL:.ml=.cmo)
XFGEN_OPTOBJS = $(XFGEN_OBJS:.cmo=.cmx)

COMMON_OBJS = $(COMMON_SOURCES:.ml=.cmo)

$(XFGEN_EXEC): $(XFGEN_OBJS)
	$(CAMLC) $(CODE_DIRS) $(CUSTOM) -o $(XFGEN_EXEC) $(LIBS) $(XFGEN_OBJS)

EKTJOIN_OBJS = $(EKTJOIN_SRC:.ml=.cmo)
EKTJOIN_OPTOBJS = $(EKTJOIN_OBJS:.cmo=.cmx)

$(EKTJOIN_EXEC): $(EKTJOIN_OBJS) 
	$(CAMLC) $(CODE_DIRS) $(CUSTOM) -o $(EKTJOIN_EXEC) $(LIBS) $(EKTJOIN_OBJS)


EKTCOMPARE_SMLIY = $(EKTCOMPARE_SRC:.mly=.ml)
EKTCOMPARE_SMLIYL = $(EKTCOMPARE_SMLIY:.mll=.ml)
EKTCOMPARE_SMLYL = $(filter %.ml,$(EKTCOMPARE_SMLIYL))
EKTCOMPARE_OBJS = $(EKTCOMPARE_SMLYL:.ml=.cmo)
EKTCOMPARE_OPTOBJS = $(EKTCOMPARE_OBJS:.cmo=.cmx)

$(EKTCOMPARE_EXEC): $(EKTCOMPARE_OBJS) 
	$(CAMLC) $(CODE_DIRS) $(CUSTOM) -o $(EKTCOMPARE_EXEC) $(LIBS) $(EKTCOMPARE_OBJS)

.SUFFIXES: .ml .mli .cmo .cmi .cmx .mll .mly 

.ml.cmo:
	$(CAMLC) $(CUSTOM) $(CODE_DIRS) -c $<

.mli.cmi:
	$(CAMLC) $(CUSTOM) $(CODE_DIRS) -c $<

.ml.cmx:
	$(CAMLOPT) $(CUSTOM) $(CODE_DIRS) -c $<

.mll.cmo:
	$(CAMLLEX) $<
	$(CAMLC) $(CUSTOM) $(CODE_DIRS) -c $*.ml

.mll.cmx:
	$(CAMLLEX) $<
	$(CAMLOPT) $(CUSTOM) $(CODE_DIRS) -c $*.ml

.mly.cmo:
	$(CAMLYACC) $<
	$(CAMLC) $(CUSTOM) $(CODE_DIRS) -c $*.mli
	$(CAMLC) $(CUSTOM) $(CODE_DIRS) -c $*.ml

.mly.cmx:
	$(CAMLYACC) $<
	$(CAMLOPT) $(CUSTOM) $(CODE_DIRS) -c $*.mli
	$(CAMLOPT) $(CUSTOM) $(CODE_DIRS) -c $*.ml

.mly.cmi:
	$(CAMLYACC) $<
	$(CAMLC) $(CUSTOM) $(CODE_DIRS) -c $*.mli

.mll.ml:
	$(CAMLLEX) $<

.mly.ml:
	$(CAMLYACC) $<

clean::
	rm -f *.cm[iox] *~ .*~ $(GENERATED_SRC_FILES) $(COMMON_DIR)/*.cm[iox]
	rm -f $(ALL_EXEC) $(ALL_EXEC_OPT)

.depend.input: Makefile
	@echo -n '--Checking Ocaml input files: '
	@(ls $(SMLIY) $(SMLIY:.ml=.mli) 2>/dev/null || true) \
	     >  .depend.new
	@diff .depend.new .depend.input 2>/dev/null 1>/dev/null && \
	    (echo 'unchanged'; rm -f .depend.new) || \
	    (echo 'changed'; mv .depend.new .depend.input)

depend: .depend

.depend:: $(SMLIY) .depend.input
	@echo '--Re-building dependencies'
	$(CAMLDEP) $(SMLIY) $(SMLIY:.ml=.mli) > .depend

include .depend
